trigger:
- main   # o la rama que uses

variables:
  vmImageName: 'ubuntu-latest'
  azureServiceConnection: 'sc-iva-dev'
  resourceGroupName: 'rg-iva-dev'
  location: 'eastus'
  appServicePlanName: 'asp-iva-dev'
  webAppName: 'app-iva-dev'

stages:
# -------------------------
# 1. Stage de infraestructura
# -------------------------
- stage: Infra
  displayName: 'Provisionar infraestructura (Bicep)'
  jobs:
  - job: DeployInfra
    displayName: 'Deploy main.bicep'
    pool:
      vmImage: $(vmImageName)

    steps:
    - task: AzureCLI@2
      displayName: 'Crear RG y desplegar Bicep'
      inputs:
        azureSubscription: $(azureServiceConnection)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Creando resource group si no existe..."
          az group create \
            --name $(resourceGroupName) \
            --location $(location)

          echo "Desplegando plantilla Bicep..."
          az deployment group create \
            --resource-group $(resourceGroupName) \
            --template-file infra/main.bicep \
            --parameters \
              location=$(location) \
              appServicePlanName=$(appServicePlanName) \
              webAppName=$(webAppName)

# -------------------------
# 2. Stage de aplicaci√≥n
# -------------------------
- stage: App
  displayName: 'Deploy app IVA'
  dependsOn: Infra
  jobs:
  - job: DeployApp
    displayName: 'Publicar web.zip en Azure Web App'
    pool:
      vmImage: $(vmImageName)

    steps:
    - task: ArchiveFiles@2
      displayName: 'Empaquetar carpeta /web en ZIP'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/web'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/web.zip'
        replaceExistingArchive: true

    - task: AzureWebApp@1
      displayName: 'Deploy a Azure Web App'
      inputs:
        azureSubscription: $(azureServiceConnection)
        appName: $(webAppName)
        package: '$(Build.ArtifactStagingDirectory)/web.zip'